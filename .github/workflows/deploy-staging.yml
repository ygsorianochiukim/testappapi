name: Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to OVH Staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ Starting STAGING deployment..."

            APP_PATH="/var/www/staging"

            if [ ! -d "$APP_PATH/.git" ]; then
              echo "üì• Cloning repository..."
              rm -rf $APP_PATH
              git clone https://github.com/ygsorianochiukim/testappapi.git $APP_PATH
            fi

            cd $APP_PATH

            echo "üîÑ Syncing develop branch..."
            git fetch origin
            git checkout develop
            git reset --hard origin/develop
            git clean -fd

            echo "üì¶ Installing Composer dependencies..."
            composer install \
              --no-dev \
              --no-interaction \
              --prefer-dist \
              --optimize-autoloader

            echo "‚öôÔ∏è Preparing environment..."
            if [ ! -f .env ]; then
              cp .env.example .env
            fi

            # --- Application ---
            sed -i "s|^APP_ENV=.*|APP_ENV=staging|" .env
            sed -i "s|^APP_DEBUG=.*|APP_DEBUG=false|" .env
            sed -i "s|^APP_URL=.*|APP_URL=${{ secrets.STAGING_APP_URL }}|" .env

            # --- Database (READ-ONLY REPLICA) ---
            sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=mysql|" .env
            sed -i "s|^DB_HOST=.*|DB_HOST=${{ secrets.DB_HOST }}|" .env
            sed -i "s|^DB_PORT=.*|DB_PORT=${{ secrets.DB_PORT }}|" .env
            sed -i "s|^DB_DATABASE=.*|DB_DATABASE=${{ secrets.DB_NAME }}|" .env
            sed -i "s|^DB_USERNAME=.*|DB_USERNAME=${{ secrets.DB_USERNAME }}|" .env
            sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=${{ secrets.DB_PASSWORD }}|" .env

            # --- REPLICA-SAFE RUNTIME DRIVERS ---
            sed -i "s|^SESSION_DRIVER=.*|SESSION_DRIVER=file|" .env
            sed -i "s|^CACHE_STORE=.*|CACHE_STORE=file|" .env
            sed -i "s|^QUEUE_CONNECTION=.*|QUEUE_CONNECTION=sync|" .env

            # --- Session domain ---
            sed -i "s|^SESSION_DOMAIN=.*|SESSION_DOMAIN=staging.rp-vespera.cloud|" .env

            echo "üîë Ensuring APP_KEY exists..."
            if ! grep -q "^APP_KEY=base64:" .env; then
              php artisan key:generate
            fi

            echo "üßπ Clearing all caches..."
            php artisan optimize:clear

            echo "üîê Fixing permissions..."
            chown -R www-data:www-data storage bootstrap/cache
            chmod -R 775 storage bootstrap/cache

            echo "‚ö° Caching config..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "‚úÖ STAGING deployment finished successfully!"
